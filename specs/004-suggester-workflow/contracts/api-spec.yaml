openapi: 3.0.3
info:
  title: Suggester Workflow API
  description: |
    API for managing suggester workflow in the Family Inventory Management System.
    
    This API enables:
    - Suggesters to view inventory and create suggestions
    - Admins to review, approve, or reject suggestions
    
    **Authentication**: All endpoints require a valid JWT token from AWS Cognito.
    **Authorization**: Role-based access control (admin/suggester) enforced by Lambda authorizer.
  version: 1.0.0
  contact:
    name: Family Inventory Team

servers:
  - url: https://api.example.com/v1
    description: Production API
  - url: https://api-dev.example.com/v1
    description: Development API

security:
  - bearerAuth: []

tags:
  - name: Suggestions
    description: Suggestion management endpoints
  - name: Inventory
    description: Inventory viewing endpoints for suggesters

paths:
  /families/{familyId}/suggestions:
    get:
      tags:
        - Suggestions
      summary: List suggestions
      description: |
        Retrieve a list of suggestions for the family.
        
        **Authorization**: Both admin and suggester roles can access.
        
        Results can be filtered by status and are ordered by creation date (newest first).
      operationId: listSuggestions
      parameters:
        - $ref: '#/components/parameters/FamilyIdPath'
        - name: status
          in: query
          description: Filter by suggestion status
          required: false
          schema:
            $ref: '#/components/schemas/SuggestionStatus'
        - name: limit
          in: query
          description: Maximum number of suggestions to return
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 25
        - name: nextToken
          in: query
          description: Pagination token from previous response
          required: false
          schema:
            type: string
      responses:
        '200':
          description: List of suggestions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuggestionListResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - Suggestions
      summary: Create a suggestion
      description: |
        Create a new suggestion for adding an item to the shopping list or creating a new inventory item.
        
        **Authorization**: Only suggester role can create suggestions.
        
        **Suggestion Types**:
        - `add_to_shopping`: Request to add an existing inventory item to the shopping list
        - `create_item`: Request to create a new inventory item
      operationId: createSuggestion
      parameters:
        - $ref: '#/components/parameters/FamilyIdPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateSuggestionRequest'
            examples:
              addToShopping:
                summary: Add to shopping list
                value:
                  type: add_to_shopping
                  itemId: 6ba7b810-9dad-11d1-80b4-00c04fd430c8
                  notes: We are almost out!
              createItem:
                summary: Create new item
                value:
                  type: create_item
                  proposedItemName: Snack Bars
                  proposedQuantity: 10
                  proposedThreshold: 5
                  notes: We need after-school snacks
      responses:
        '201':
          description: Suggestion created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuggestionResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Forbidden - Only suggesters can create suggestions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Referenced inventory item not found (for add_to_shopping)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /families/{familyId}/suggestions/{suggestionId}:
    get:
      tags:
        - Suggestions
      summary: Get suggestion details
      description: |
        Retrieve details of a specific suggestion.
        
        **Authorization**: Both admin and suggester roles can access.
      operationId: getSuggestion
      parameters:
        - $ref: '#/components/parameters/FamilyIdPath'
        - $ref: '#/components/parameters/SuggestionIdPath'
      responses:
        '200':
          description: Suggestion details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuggestionResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /families/{familyId}/suggestions/{suggestionId}/approve:
    post:
      tags:
        - Suggestions
      summary: Approve a suggestion
      description: |
        Approve a pending suggestion and execute the suggested action.
        
        **Authorization**: Only admin role can approve suggestions.
        
        **Actions on Approval**:
        - `add_to_shopping`: Creates a ShoppingListItem for the referenced inventory item
        - `create_item`: Creates a new InventoryItem with the proposed attributes
        
        **Atomic Execution**: The approval and action are executed atomically using DynamoDB transactions.
        
        **Optimistic Locking**: The `version` field must match the current suggestion version.
      operationId: approveSuggestion
      parameters:
        - $ref: '#/components/parameters/FamilyIdPath'
        - $ref: '#/components/parameters/SuggestionIdPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ApproveSuggestionRequest'
            example:
              version: 1
      responses:
        '200':
          description: Suggestion approved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApproveSuggestionResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Forbidden - Only admins can approve suggestions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Conflict - Suggestion already reviewed or version mismatch
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConflictErrorResponse'
        '422':
          description: Unprocessable Entity - Referenced item deleted or duplicate item name
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnprocessableEntityResponse'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /families/{familyId}/suggestions/{suggestionId}/reject:
    post:
      tags:
        - Suggestions
      summary: Reject a suggestion
      description: |
        Reject a pending suggestion without executing any action.
        
        **Authorization**: Only admin role can reject suggestions.
        
        **Optimistic Locking**: The `version` field must match the current suggestion version.
      operationId: rejectSuggestion
      parameters:
        - $ref: '#/components/parameters/FamilyIdPath'
        - $ref: '#/components/parameters/SuggestionIdPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RejectSuggestionRequest'
            example:
              version: 1
              rejectionNotes: We already have enough of this item
      responses:
        '200':
          description: Suggestion rejected successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuggestionResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Forbidden - Only admins can reject suggestions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Conflict - Suggestion already reviewed or version mismatch
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConflictErrorResponse'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /families/{familyId}/inventory:
    get:
      tags:
        - Inventory
      summary: List inventory items (read-only for suggesters)
      description: |
        Retrieve a list of active inventory items for the family.
        
        **Authorization**: Both admin and suggester roles can access.
        
        This endpoint provides read-only access to inventory for suggesters to view
        what items are available before creating suggestions.
      operationId: listInventoryItems
      parameters:
        - $ref: '#/components/parameters/FamilyIdPath'
        - name: limit
          in: query
          description: Maximum number of items to return
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
        - name: nextToken
          in: query
          description: Pagination token from previous response
          required: false
          schema:
            type: string
      responses:
        '200':
          description: List of inventory items
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InventoryListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: AWS Cognito JWT token

  parameters:
    FamilyIdPath:
      name: familyId
      in: path
      description: Unique identifier of the family
      required: true
      schema:
        type: string
        format: uuid
        example: f47ac10b-58cc-4372-a567-0e02b2c3d479

    SuggestionIdPath:
      name: suggestionId
      in: path
      description: Unique identifier of the suggestion
      required: true
      schema:
        type: string
        format: uuid
        example: af14e45f-ceea-467a-9b36-34f6c3b3e7d3

  schemas:
    # Enums
    SuggestionType:
      type: string
      enum:
        - add_to_shopping
        - create_item
      description: Type of suggestion

    SuggestionStatus:
      type: string
      enum:
        - pending
        - approved
        - rejected
      description: Status of the suggestion

    # Request Schemas
    CreateSuggestionRequest:
      oneOf:
        - $ref: '#/components/schemas/CreateAddToShoppingSuggestionRequest'
        - $ref: '#/components/schemas/CreateItemSuggestionRequest'
      discriminator:
        propertyName: type
        mapping:
          add_to_shopping: '#/components/schemas/CreateAddToShoppingSuggestionRequest'
          create_item: '#/components/schemas/CreateItemSuggestionRequest'

    CreateAddToShoppingSuggestionRequest:
      type: object
      required:
        - type
        - itemId
      properties:
        type:
          type: string
          enum:
            - add_to_shopping
        itemId:
          type: string
          format: uuid
          description: ID of the inventory item to add to shopping list
        notes:
          type: string
          maxLength: 500
          description: Optional notes from the suggester

    CreateItemSuggestionRequest:
      type: object
      required:
        - type
        - proposedItemName
      properties:
        type:
          type: string
          enum:
            - create_item
        proposedItemName:
          type: string
          minLength: 1
          maxLength: 100
          description: Name for the new inventory item
        proposedQuantity:
          type: integer
          minimum: 0
          description: Initial quantity for the new item (defaults to 0)
        proposedThreshold:
          type: integer
          minimum: 0
          description: Low-stock threshold for the new item (defaults to 0)
        notes:
          type: string
          maxLength: 500
          description: Optional notes from the suggester

    ApproveSuggestionRequest:
      type: object
      required:
        - version
      properties:
        version:
          type: integer
          minimum: 1
          description: Current version of the suggestion for optimistic locking

    RejectSuggestionRequest:
      type: object
      required:
        - version
      properties:
        version:
          type: integer
          minimum: 1
          description: Current version of the suggestion for optimistic locking
        rejectionNotes:
          type: string
          maxLength: 500
          description: Optional reason for rejection

    # Response Schemas
    SuggestionResponse:
      type: object
      properties:
        suggestionId:
          type: string
          format: uuid
        familyId:
          type: string
          format: uuid
        suggestedBy:
          type: string
          format: uuid
        suggestedByName:
          type: string
          description: Name of the suggester (preserved after removal)
        type:
          $ref: '#/components/schemas/SuggestionType'
        status:
          $ref: '#/components/schemas/SuggestionStatus'
        itemId:
          type: string
          format: uuid
          nullable: true
          description: Referenced inventory item ID (for add_to_shopping)
        itemNameSnapshot:
          type: string
          nullable: true
          description: Snapshot of item name (for add_to_shopping)
        proposedItemName:
          type: string
          nullable: true
          description: Proposed item name (for create_item)
        proposedQuantity:
          type: integer
          nullable: true
          description: Proposed quantity (for create_item)
        proposedThreshold:
          type: integer
          nullable: true
          description: Proposed threshold (for create_item)
        notes:
          type: string
          nullable: true
          description: Notes from the suggester
        rejectionNotes:
          type: string
          nullable: true
          description: Rejection reason from admin
        reviewedBy:
          type: string
          format: uuid
          nullable: true
          description: ID of admin who reviewed
        reviewedAt:
          type: string
          format: date-time
          nullable: true
          description: Timestamp when reviewed
        version:
          type: integer
          description: Version for optimistic locking
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        # Computed fields
        suggesterStatus:
          type: string
          enum:
            - active
            - removed
          description: Current status of the suggester member
        itemStatus:
          type: string
          enum:
            - active
            - archived
            - deleted
          nullable: true
          description: Current status of referenced item (for add_to_shopping)

    SuggestionListResponse:
      type: object
      properties:
        suggestions:
          type: array
          items:
            $ref: '#/components/schemas/SuggestionResponse'
        nextToken:
          type: string
          nullable: true
          description: Token for fetching next page of results

    ApproveSuggestionResponse:
      type: object
      properties:
        suggestion:
          $ref: '#/components/schemas/SuggestionResponse'
        createdItem:
          type: object
          nullable: true
          description: The created ShoppingListItem or InventoryItem
          properties:
            type:
              type: string
              enum:
                - ShoppingListItem
                - InventoryItem
            id:
              type: string
              format: uuid
            name:
              type: string

    InventoryItemResponse:
      type: object
      properties:
        itemId:
          type: string
          format: uuid
        familyId:
          type: string
          format: uuid
        name:
          type: string
        quantity:
          type: integer
        threshold:
          type: integer
        locationId:
          type: string
          format: uuid
          nullable: true
        status:
          type: string
          enum:
            - active
            - archived
        isLowStock:
          type: boolean
          description: True if quantity is below threshold
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    InventoryListResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/InventoryItemResponse'
        nextToken:
          type: string
          nullable: true
          description: Token for fetching next page of results

    # Error Schemas
    ErrorResponse:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Error type
        message:
          type: string
          description: Human-readable error message
        details:
          type: object
          additionalProperties: true
          description: Additional error details

    ConflictErrorResponse:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          enum:
            - Conflict
        message:
          type: string
          description: Description of the conflict
        currentState:
          $ref: '#/components/schemas/SuggestionResponse'
          description: Current state of the suggestion

    UnprocessableEntityResponse:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          enum:
            - Unprocessable Entity
        message:
          type: string
          description: Description of why the request cannot be processed
        suggestion:
          $ref: '#/components/schemas/SuggestionResponse'
          description: The suggestion that could not be processed
        itemStatus:
          type: string
          enum:
            - archived
            - deleted
          description: Status of the referenced item (for add_to_shopping)
        duplicateItemName:
          type: string
          description: Name of existing item that conflicts (for create_item)

  responses:
    BadRequest:
      description: Bad Request - Invalid input parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: Bad Request
            message: Invalid request body
            details:
              field: proposedItemName
              issue: must be between 1 and 100 characters

    Unauthorized:
      description: Unauthorized - Missing or invalid authentication token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: Unauthorized
            message: Missing or invalid authentication token

    Forbidden:
      description: Forbidden - Insufficient permissions
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: Forbidden
            message: You do not have permission to access this resource

    NotFound:
      description: Not Found - Resource does not exist
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: Not Found
            message: Suggestion not found

    InternalServerError:
      description: Internal Server Error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: Internal Server Error
            message: An unexpected error occurred
