openapi: 3.0.3
info:
  title: Reference Data Management API
  description: |
    RESTful API for managing family reference data including storage locations and stores.
    Part of the Family Inventory Management system (Feature 005-reference-data).
    
    Key features:
    - CRUD operations for storage locations and stores
    - Optimistic locking with version field for concurrent edit protection
    - Case-insensitive name uniqueness enforcement
    - Reference checking before deletion
    - Real-time name availability checking
  version: 1.0.0
  contact:
    name: API Support

servers:
  - url: https://api.inventory-mgmt.example.com/v1
    description: Production server
  - url: https://api-staging.inventory-mgmt.example.com/v1
    description: Staging server
  - url: http://localhost:3000/v1
    description: Local development server

security:
  - BearerAuth: []

tags:
  - name: Storage Locations
    description: Storage location management (pantry, garage, refrigerator, etc.)
  - name: Stores
    description: Store management (grocery stores, hardware stores, etc.)

paths:
  # ==================== STORAGE LOCATIONS ====================
  /families/{familyId}/locations:
    get:
      tags: [Storage Locations]
      summary: List all storage locations
      description: Retrieve all storage locations for the family
      operationId: listStorageLocations
      parameters:
        - $ref: '#/components/parameters/FamilyId'
      responses:
        '200':
          description: List of storage locations
          content:
            application/json:
              schema:
                type: object
                properties:
                  locations:
                    type: array
                    items:
                      $ref: '#/components/schemas/StorageLocationResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags: [Storage Locations]
      summary: Create a new storage location
      description: Add a new storage location to the family (admin only)
      operationId: createStorageLocation
      parameters:
        - $ref: '#/components/parameters/FamilyId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateStorageLocationRequest'
      responses:
        '201':
          description: Storage location created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StorageLocationResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          description: Duplicate name conflict
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DuplicateNameError'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /families/{familyId}/locations/{locationId}:
    get:
      tags: [Storage Locations]
      summary: Get a specific storage location
      description: Retrieve details for a specific storage location
      operationId: getStorageLocation
      parameters:
        - $ref: '#/components/parameters/FamilyId'
        - $ref: '#/components/parameters/LocationId'
      responses:
        '200':
          description: Storage location details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StorageLocationResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      tags: [Storage Locations]
      summary: Update a storage location
      description: |
        Update a storage location (admin only). Requires version for optimistic locking.
        If the version doesn't match the current version, returns 409 Conflict.
      operationId: updateStorageLocation
      parameters:
        - $ref: '#/components/parameters/FamilyId'
        - $ref: '#/components/parameters/LocationId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateStorageLocationRequest'
      responses:
        '200':
          description: Storage location updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StorageLocationResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Conflict - duplicate name or version mismatch
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/DuplicateNameError'
                  - $ref: '#/components/schemas/VersionConflictError'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags: [Storage Locations]
      summary: Delete a storage location
      description: |
        Delete a storage location (admin only). 
        Checks for references first - cannot delete if referenced by inventory items.
      operationId: deleteStorageLocation
      parameters:
        - $ref: '#/components/parameters/FamilyId'
        - $ref: '#/components/parameters/LocationId'
      responses:
        '204':
          description: Storage location deleted successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Cannot delete - location is referenced by inventory items
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReferenceConflictError'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /families/{familyId}/locations/check-name:
    post:
      tags: [Storage Locations]
      summary: Check if a location name is available
      description: |
        Check if a storage location name is available for use (case-insensitive).
        Used for real-time validation during data entry.
      operationId: checkStorageLocationName
      parameters:
        - $ref: '#/components/parameters/FamilyId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CheckNameRequest'
      responses:
        '200':
          description: Name availability check result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CheckNameResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

  # ==================== STORES ====================
  /families/{familyId}/stores:
    get:
      tags: [Stores]
      summary: List all stores
      description: Retrieve all stores for the family
      operationId: listStores
      parameters:
        - $ref: '#/components/parameters/FamilyId'
      responses:
        '200':
          description: List of stores
          content:
            application/json:
              schema:
                type: object
                properties:
                  stores:
                    type: array
                    items:
                      $ref: '#/components/schemas/StoreResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags: [Stores]
      summary: Create a new store
      description: Add a new store to the family (admin only)
      operationId: createStore
      parameters:
        - $ref: '#/components/parameters/FamilyId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateStoreRequest'
      responses:
        '201':
          description: Store created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StoreResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          description: Duplicate name conflict
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DuplicateNameError'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /families/{familyId}/stores/{storeId}:
    get:
      tags: [Stores]
      summary: Get a specific store
      description: Retrieve details for a specific store
      operationId: getStore
      parameters:
        - $ref: '#/components/parameters/FamilyId'
        - $ref: '#/components/parameters/StoreId'
      responses:
        '200':
          description: Store details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StoreResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      tags: [Stores]
      summary: Update a store
      description: |
        Update a store (admin only). Requires version for optimistic locking.
        If the version doesn't match the current version, returns 409 Conflict.
      operationId: updateStore
      parameters:
        - $ref: '#/components/parameters/FamilyId'
        - $ref: '#/components/parameters/StoreId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateStoreRequest'
      responses:
        '200':
          description: Store updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StoreResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Conflict - duplicate name or version mismatch
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/DuplicateNameError'
                  - $ref: '#/components/schemas/VersionConflictError'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags: [Stores]
      summary: Delete a store
      description: |
        Delete a store (admin only).
        Checks for references first - cannot delete if referenced by inventory items or shopping list items.
      operationId: deleteStore
      parameters:
        - $ref: '#/components/parameters/FamilyId'
        - $ref: '#/components/parameters/StoreId'
      responses:
        '204':
          description: Store deleted successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Cannot delete - store is referenced by inventory items or shopping list items
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReferenceConflictError'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /families/{familyId}/stores/check-name:
    post:
      tags: [Stores]
      summary: Check if a store name is available
      description: |
        Check if a store name is available for use (case-insensitive).
        Used for real-time validation during data entry.
      operationId: checkStoreName
      parameters:
        - $ref: '#/components/parameters/FamilyId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CheckNameRequest'
      responses:
        '200':
          description: Name availability check result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CheckNameResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

# ==================== COMPONENTS ====================
components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: AWS Cognito JWT token

  parameters:
    FamilyId:
      name: familyId
      in: path
      required: true
      description: Family UUID
      schema:
        type: string
        format: uuid

    LocationId:
      name: locationId
      in: path
      required: true
      description: Storage location UUID
      schema:
        type: string
        format: uuid

    StoreId:
      name: storeId
      in: path
      required: true
      description: Store UUID
      schema:
        type: string
        format: uuid

  schemas:
    # ========== REQUEST SCHEMAS ==========
    CreateStorageLocationRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 50
          description: Storage location name (1-50 characters, trimmed)
          example: "Kitchen Pantry"
        description:
          type: string
          maxLength: 200
          nullable: true
          description: Optional description (0-200 characters, trimmed)
          example: "Main pantry cabinet in the kitchen"

    UpdateStorageLocationRequest:
      type: object
      required:
        - version
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 50
          description: Storage location name (1-50 characters, trimmed)
          example: "Kitchen Pantry"
        description:
          type: string
          maxLength: 200
          nullable: true
          description: Optional description (0-200 characters, trimmed)
          example: "Main pantry cabinet in the kitchen"
        version:
          type: integer
          minimum: 1
          description: Current version for optimistic locking (required)
          example: 1

    CreateStoreRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
          description: Store name (1-100 characters, trimmed)
          example: "Whole Foods Market"
        address:
          type: string
          maxLength: 200
          nullable: true
          description: Optional address (0-200 characters, trimmed)
          example: "123 Main St, Anytown, USA"

    UpdateStoreRequest:
      type: object
      required:
        - version
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
          description: Store name (1-100 characters, trimmed)
          example: "Whole Foods Market"
        address:
          type: string
          maxLength: 200
          nullable: true
          description: Optional address (0-200 characters, trimmed)
          example: "123 Main St, Anytown, USA"
        version:
          type: integer
          minimum: 1
          description: Current version for optimistic locking (required)
          example: 1

    CheckNameRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          minLength: 1
          description: Name to check for availability
          example: "Kitchen Pantry"
        excludeId:
          type: string
          format: uuid
          nullable: true
          description: ID to exclude from check (for updates - exclude self)
          example: "7c9e6679-7425-40de-944b-e07fc1f90ae7"

    # ========== RESPONSE SCHEMAS ==========
    StorageLocationResponse:
      type: object
      required:
        - locationId
        - familyId
        - name
        - version
        - createdAt
        - updatedAt
      properties:
        locationId:
          type: string
          format: uuid
          description: Unique identifier for the storage location
          example: "7c9e6679-7425-40de-944b-e07fc1f90ae7"
        familyId:
          type: string
          format: uuid
          description: Family this location belongs to
          example: "f47ac10b-58cc-4372-a567-0e02b2c3d479"
        name:
          type: string
          description: Storage location name (original casing preserved)
          example: "Kitchen Pantry"
        description:
          type: string
          nullable: true
          description: Optional description
          example: "Main pantry cabinet in the kitchen"
        version:
          type: integer
          minimum: 1
          description: Version number for optimistic locking
          example: 1
        createdAt:
          type: string
          format: date-time
          description: ISO 8601 timestamp of creation
          example: "2025-12-10T10:00:00Z"
        updatedAt:
          type: string
          format: date-time
          description: ISO 8601 timestamp of last update
          example: "2025-12-10T10:00:00Z"

    StoreResponse:
      type: object
      required:
        - storeId
        - familyId
        - name
        - version
        - createdAt
        - updatedAt
      properties:
        storeId:
          type: string
          format: uuid
          description: Unique identifier for the store
          example: "123e4567-e89b-12d3-a456-426614174000"
        familyId:
          type: string
          format: uuid
          description: Family this store belongs to
          example: "f47ac10b-58cc-4372-a567-0e02b2c3d479"
        name:
          type: string
          description: Store name (original casing preserved)
          example: "Whole Foods Market"
        address:
          type: string
          nullable: true
          description: Optional address
          example: "123 Main St, Anytown, USA"
        version:
          type: integer
          minimum: 1
          description: Version number for optimistic locking
          example: 1
        createdAt:
          type: string
          format: date-time
          description: ISO 8601 timestamp of creation
          example: "2025-12-10T10:00:00Z"
        updatedAt:
          type: string
          format: date-time
          description: ISO 8601 timestamp of last update
          example: "2025-12-10T14:30:00Z"

    CheckNameResponse:
      type: object
      required:
        - available
      properties:
        available:
          type: boolean
          description: Whether the name is available for use
          example: true
        message:
          type: string
          nullable: true
          description: Explanation if name is not available
          example: "A storage location named \"Kitchen Pantry\" already exists"

    # ========== ERROR SCHEMAS ==========
    ErrorResponse:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Error code
          example: "BadRequest"
        message:
          type: string
          description: Human-readable error message
          example: "Validation failed"
        details:
          type: array
          items:
            type: object
            properties:
              field:
                type: string
                description: Field that caused the error
                example: "name"
              message:
                type: string
                description: Field-specific error message
                example: "Name is required"

    DuplicateNameError:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          enum: [DUPLICATE_NAME]
          description: Error code for duplicate name
          example: "DUPLICATE_NAME"
        message:
          type: string
          description: Human-readable error message
          example: "A storage location named \"Kitchen Pantry\" already exists"

    VersionConflictError:
      type: object
      required:
        - error
        - message
        - currentVersion
        - currentEntity
      properties:
        error:
          type: string
          enum: [VERSION_CONFLICT]
          description: Error code for version mismatch
          example: "VERSION_CONFLICT"
        message:
          type: string
          description: Human-readable error message
          example: "This item was modified by another user"
        currentVersion:
          type: integer
          description: Current version of the entity
          example: 2
        currentEntity:
          oneOf:
            - $ref: '#/components/schemas/StorageLocationResponse'
            - $ref: '#/components/schemas/StoreResponse'
          description: Current state of the entity

    ReferenceConflictError:
      type: object
      required:
        - error
        - message
        - references
      properties:
        error:
          type: string
          enum: [REFERENCE_EXISTS]
          description: Error code for reference conflict
          example: "REFERENCE_EXISTS"
        message:
          type: string
          description: Human-readable error message
          example: "Cannot delete storage location that is referenced by inventory items"
        references:
          type: object
          required:
            - inventoryItems
          properties:
            inventoryItems:
              type: integer
              minimum: 0
              description: Count of inventory items referencing this entity
              example: 5
            shoppingListItems:
              type: integer
              minimum: 0
              description: Count of shopping list items referencing this entity (stores only)
              example: 2

  responses:
    BadRequest:
      description: Bad request - validation error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    Unauthorized:
      description: Unauthorized - missing or invalid authentication
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    Forbidden:
      description: Forbidden - insufficient permissions (not an admin)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
