openapi: 3.0.3
info:
  title: Pending Invitation Onboarding API
  version: 1.0.0
  description: |
    Serverless endpoints that power the post-signup pending invitation flow.
    All endpoints require authenticated requests (Cognito session) and respond
    with the shared success/error response utilities defined in the constitution.
servers:
  - url: https://api.inventory-management.example.com
paths:
  /pending-invitations:
    get:
      summary: Fetch pending invitations for the currently verified identity
      operationId: getPendingInvitations
      security:
        - cognitoAuthorizer: []
      responses:
        '200':
          description: Pending invitations were found (possibly zero)
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/PendingInvitationList'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/ServerError'
  /pending-invitations/{inviteId}/accept:
    post:
      summary: Accept a specific invitation detected during signup
      operationId: acceptPendingInvitation
      security:
        - cognitoAuthorizer: []
      parameters:
        - name: inviteId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AcceptInvitationRequest'
      responses:
        '200':
          description: Invitation accepted and membership provisioned
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/DecisionResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '403':
          description: Invite does not belong to this user or switch confirmation missing
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Invitation is no longer pending
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          $ref: '#/components/responses/ServerError'
  /pending-invitations/{inviteId}/decline:
    post:
      summary: Decline a pending invitation without joining the family
      operationId: declinePendingInvitation
      security:
        - cognitoAuthorizer: []
      parameters:
        - name: inviteId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeclineInvitationRequest'
      responses:
        '200':
          description: Invitation declined
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/DecisionResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/ServerError'
  /pending-invitations/decline-all:
    post:
      summary: Decline all detected invites ("Create my own family" path)
      operationId: declineAllPendingInvitations
      security:
        - cognitoAuthorizer: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeclineAllRequest'
      responses:
        '200':
          description: All invitations declined and logged
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/DecisionResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/ServerError'

components:
  securitySchemes:
    cognitoAuthorizer:
      type: http
      scheme: bearer
      bearerFormat: JWT
  responses:
    Unauthorized:
      description: Authentication failed
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    BadRequest:
      description: Validation failed
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    ServerError:
      description: Unexpected server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
  schemas:
    PendingInvitationList:
      type: object
      properties:
        invites:
          type: array
          items:
            $ref: '#/components/schemas/PendingInvitation'
        existingMembership:
          $ref: '#/components/schemas/ExistingMembershipSummary'
        decisionToken:
          type: string
          description: Opaque nonce that must accompany accept/decline calls to prevent replay
    PendingInvitation:
      type: object
      required:
        - inviteId
        - familyId
        - familyName
        - inviterName
        - roleOffered
        - expiresAt
        - status
      properties:
        inviteId:
          type: string
        familyId:
          type: string
        familyName:
          type: string
        inviterName:
          type: string
        roleOffered:
          type: string
          enum: [admin, manager, viewer, shopper]
        expiresAt:
          type: string
          format: date-time
        status:
          type: string
          enum: [PENDING, EXPIRED, REVOKED]
        requiresSwitchConfirmation:
          type: boolean
          description: True when the user already belongs to a different family
        message:
          type: string
          description: Optional host-provided note
    ExistingMembershipSummary:
      type: object
      properties:
        familyId:
          type: string
        familyName:
          type: string
        role:
          type: string
        status:
          type: string
          enum: [ACTIVE, PENDING_SWITCH, SUSPENDED]
    AcceptInvitationRequest:
      type: object
      required:
        - decisionToken
      properties:
        decisionToken:
          type: string
        switchConfirmed:
          type: boolean
          description: Required when requiresSwitchConfirmation is true
        trackAnalytics:
          type: boolean
          description: Optional flag used by frontend instrumentation; ignored by backend logic
    DeclineInvitationRequest:
      type: object
      required:
        - decisionToken
      properties:
        decisionToken:
          type: string
        reason:
          type: string
          maxLength: 280
    DeclineAllRequest:
      type: object
      required:
        - decisionToken
      properties:
        decisionToken:
          type: string
        reason:
          type: string
          description: Applies to all invite decline logs
    DecisionResponse:
      type: object
      properties:
        inviteId:
          type: string
        familyId:
          type: string
        action:
          type: string
          enum: [ACCEPTED, DECLINED]
        membershipId:
          type: string
          nullable: true
        auditId:
          type: string
        redirect:
          type: string
          description: Next route the frontend should navigate to (family dashboard or create-family flow)
    ErrorResponse:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
        message:
          type: string
        details:
          type: array
          items:
            type: string
        correlationId:
          type: string
