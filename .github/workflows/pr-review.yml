# GitHub Actions Workflow for Copilot PR Review (Context Repository)
# This workflow triggers GitHub Copilot code review on pull requests
# for the Context repository itself.
#
# Architecture Reference: .specify/memory/multi-repo-pr-review-architecture.md
#
# This workflow calls the reusable workflow for consistency across all repos.
# For Backend/Frontend repos, use the caller template at:
#   .github/workflows/templates/caller-workflow.yml

name: Copilot PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - develop

# Prevent concurrent reviews on the same PR
concurrency:
  group: pr-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # For the Context repository, we run the review directly since we have all files locally
  # This avoids the circular dependency of the Context repo calling itself
  copilot-review:
    name: Copilot Code Review
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    permissions:
      contents: read
      pull-requests: write
      checks: write

    env:
      # Feature flag to enable/disable Copilot action
      # Set to 'false' because github/copilot-code-review-action@v1 is not yet publicly available
      COPILOT_ACTION_ENABLED: 'false'

    steps:
      # Step 1: Checkout repository with full history for context
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Step 2: Make the aggregation script executable
      - name: Setup scripts
        run: |
          chmod +x .github/scripts/aggregate-rules.sh

      # Step 3: Aggregate rules from all sources
      - name: Aggregate review rules
        id: rules
        run: |
          echo "Aggregating rules from constitution and agent files..."
          
          if .github/scripts/aggregate-rules.sh /tmp/review-context.md; then
            echo "‚úÖ Review context generated successfully"
            echo "context_generated=true" >> $GITHUB_OUTPUT
            echo "context_file=/tmp/review-context.md" >> $GITHUB_OUTPUT
            FILE_SIZE=$(wc -c < /tmp/review-context.md)
            echo "Context file size: ${FILE_SIZE} bytes"
          else
            echo "‚ùå Failed to generate review context"
            echo "context_generated=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      # Step 4: Get constitution version for tracking
      - name: Get constitution version
        id: constitution
        run: |
          if [[ -f .specify/memory/constitution.md ]]; then
            VERSION=$(grep -oP '\*\*Version\*\*: \K[0-9]+\.[0-9]+\.[0-9]+' .specify/memory/constitution.md 2>/dev/null || echo "unknown")
          else
            VERSION="unknown"
            echo "‚ö†Ô∏è Constitution file not found"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üìú Constitution version: $VERSION"

      # Step 5: Check if Copilot action is available
      - name: Check Copilot action availability
        id: copilot_check
        run: |
          if [[ "${{ env.COPILOT_ACTION_ENABLED }}" == "true" ]]; then
            echo "copilot_available=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Copilot action is enabled"
          else
            echo "copilot_available=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è Copilot action is disabled via COPILOT_ACTION_ENABLED"
          fi

      # Step 6: Request Copilot Code Review (if available)
      - name: Request Copilot Code Review
        id: review
        if: steps.copilot_check.outputs.copilot_available == 'true'
        uses: github/copilot-code-review-action@v1
        with:
          custom-instructions-file: .github/agents/speckit.pr-review.agent.md
        continue-on-error: true

      # Step 7: Fallback - Post review guidelines if Copilot action failed or unavailable
      - name: Fallback - Post review guidelines
        if: steps.copilot_check.outputs.copilot_available == 'false' || steps.review.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const constitutionVersion = '${{ steps.constitution.outputs.version }}';
            const reviewDate = new Date().toISOString();
            const prNumber = context.issue.number;
            const copilotAvailable = '${{ steps.copilot_check.outputs.copilot_available }}' === 'true';
            const reviewOutcome = '${{ steps.review.outcome }}';
            
            let fallbackReason = '';
            if (!copilotAvailable) {
              fallbackReason = 'GitHub Copilot code review action is not available or disabled.';
            } else if (reviewOutcome === 'failure') {
              fallbackReason = 'GitHub Copilot code review action encountered an error.';
            }
            
            let reviewGuidelines = '';
            try {
              const contextPath = '/tmp/review-context.md';
              if (fs.existsSync(contextPath)) {
                const fullContext = fs.readFileSync(contextPath, 'utf8');
                const instructionsMatch = fullContext.match(/## Review Instructions[\s\S]*$/);
                if (instructionsMatch) {
                  reviewGuidelines = instructionsMatch[0];
                }
              }
            } catch (error) {
              console.log('Could not read review context:', error.message);
            }
            
            const body = [
              '## ü§ñ PR Review Guidelines',
              '',
              '> **Context Repository**: This is the central rules repository',
              '>',
              '> ‚ö†Ô∏è **Fallback Mode**: ' + fallbackReason,
              '',
              '| Field | Value |',
              '|-------|-------|',
              '| Constitution Version | ' + constitutionVersion + ' |',
              '| Review Date | ' + reviewDate + ' |',
              '| Repository Type | context |',
              '| PR Number | #' + prNumber + ' |',
              '',
              '### Validation Categories',
              '',
              '| Category | Severity |',
              '|----------|----------|',
              '| TypeScript Compliance | üî¥ CRITICAL |',
              '| Testing Requirements | üî¥ CRITICAL |',
              '| AWS Best Practices | üü† HIGH |',
              '| Security Standards | üî¥ CRITICAL |',
              '| Code Organization | üü° MEDIUM |',
              '',
              '<details>',
              '<summary>üìã Review Instructions</summary>',
              '',
              reviewGuidelines || '> See constitution for full guidelines',
              '',
              '</details>',
              '',
              '*Rules from Context repository - Constitution v' + constitutionVersion + '*'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });
            
            console.log('Fallback review guidelines posted successfully');

      # Step 8: Post review summary comment (when Copilot review succeeded)
      - name: Post review summary
        if: steps.review.outcome == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const constitutionVersion = '${{ steps.constitution.outputs.version }}';
            const reviewDate = new Date().toISOString();
            const prNumber = context.issue.number;
            
            const body = [
              '## ü§ñ Copilot Code Review ‚úÖ',
              '',
              '> **Context Repository**: This is the central rules repository',
              '',
              '| Field | Value |',
              '|-------|-------|',
              '| Constitution Version | ' + constitutionVersion + ' |',
              '| Review Date | ' + reviewDate + ' |',
              '| Repository Type | context |',
              '| PR Number | #' + prNumber + ' |',
              '',
              'Copilot code review completed successfully.',
              '',
              '### Validation Categories',
              '',
              '| Category | Severity |',
              '|----------|----------|',
              '| TypeScript Compliance | CRITICAL |',
              '| Testing Requirements | CRITICAL |',
              '| AWS Best Practices | HIGH |',
              '| Security Standards | CRITICAL |',
              '| Code Organization | MEDIUM |',
              '',
              '---',
              '',
              'See inline comments for detailed findings.',
              '',
              '*Review powered by GitHub Copilot with project constitution v' + constitutionVersion + '*'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });
            
            console.log('Review summary posted successfully');

      # Step 9: Set final check status based on review outcome
      - name: Set check status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const reviewOutcome = '${{ steps.review.outcome }}';
            const copilotAvailable = '${{ steps.copilot_check.outputs.copilot_available }}' === 'true';
            const constitutionVersion = '${{ steps.constitution.outputs.version }}';
            const contextGenerated = '${{ steps.rules.outputs.context_generated }}' === 'true';
            
            let conclusion = 'neutral';
            let summary = '';
            
            if (!contextGenerated) {
              conclusion = 'failure';
              summary = 'Failed to generate review context. Check workflow logs for details.';
            } else if (!copilotAvailable) {
              summary = 'Manual review guidelines posted. Constitution v' + constitutionVersion + ' | Repo type: context';
            } else if (reviewOutcome === 'success') {
              conclusion = 'success';
              summary = 'Code review completed. Constitution v' + constitutionVersion + ' | Repo type: context';
            } else {
              summary = 'Review completed with fallback. Constitution v' + constitutionVersion + ' | Repo type: context';
            }
            
            try {
              await github.rest.checks.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'Copilot PR Review',
                head_sha: context.payload.pull_request.head.sha,
                status: 'completed',
                conclusion: conclusion,
                output: {
                  title: 'Copilot PR Review',
                  summary: summary,
                  text: [
                    'Constitution Version: ' + constitutionVersion,
                    'Repository Type: context',
                    'Review Date: ' + new Date().toISOString(),
                    'Copilot Available: ' + copilotAvailable,
                    'Context Generated: ' + contextGenerated
                  ].join('\n')
                }
              });
              
              console.log('Check status set to: ' + conclusion);
            } catch (error) {
              console.log('Failed to create check run:', error.message);
            }